{% extends "base.html" %}
{% block content %}
<h1 class="page-title">Hi, {{ username }} üëã</h1>

<div class="grid-3">
  <div class="card accent">
    <h3>Current Balance</h3>
    <p class="big-num">{{ "{:,.2f}".format(balance) }}</p>
  </div>
  <div class="card green">
    <h3>Total Income</h3>
    <p class="big-num">{{ "{:,.2f}".format(total_income) }}</p>
  </div>
  <div class="card red">
    <h3>Total Expense</h3>
    <p class="big-num">{{ "{:,.2f}".format(total_expense) }}</p>
  </div>
</div>
<div>
  <div class="action-buttons">
  <a href="{{ url_for('add_transaction') }}" class="btn-primary">
    ‚ûï Add Transaction
  </a>
  <a href="{{ url_for('view_transactions') }}" class="btn-secondary">
    üìÑ View Transactions
  </a>
</div>

{% if goals and goals|length > 0 %}
<div class="card mt">
  <h3 style="margin-bottom:1rem">Your Goals</h3>
  <div class="goals-grid">
    {% for g in goals %}
      <div class="goal-card">
        <canvas id="goalChart{{ g.id }}" width="140" height="140"></canvas>
        <div class="goal-caption">
          <strong>{{ g.name }}</strong>
          <div class="muted">{{ "{:,.2f}".format(g.current) }} / {{ "{:,.2f}".format(g.target) }} THB</div>
          <div class="muted">{{ "{:.1f}".format(g.percent) }}%</div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<script>
  // ‡πÉ‡∏ä‡πâ Chart.js ‡∏ó‡∏≥ doughnut
  const goalsData = {{ goals|tojson }};
  goalsData.forEach(g => {
    const ctx = document.getElementById('goalChart'+g.id).getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        datasets: [{
          data: [g.percent, 100 - g.percent],
          backgroundColor: ['#38bdf8', 'rgba(148,163,184,0.2)'],
          borderWidth: 0
        }]
      },
      options: {
        cutout: '70%',
        plugins: { legend: { display: false }, tooltip: { enabled: false } }
      }
    });
  });
</script>
{% endif %}


</div>

{% if budget_amount %}
  <div class="card mt">
    <h3>Budget this month</h3>
    <p>Budget: {{ "{:,.2f}".format(budget_amount) }}</p>
    <p>Expense this month: {{ "{:,.2f}".format(month_expense) }}</p>
    {% if warn_over %}
      <p class="text-danger">‚ö†Ô∏è You already spent over 80% of your budget!</p>
    {% else %}
      <p class="text-success">‚úÖ You are within your budget.</p>
    {% endif %}
  </div>
{% endif %}

<div class="card mt">
  <h3>Last 7 Days</h3>
  <canvas id="historyChart" height="120"></canvas>
</div>

<div class="converter-card mt">
  <h3>‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô</h3>
  
  <div class="converter-form">
    <div>
      <label for="amount">Amount</label>
      <input type="number" step="0.01" id="amount" placeholder="100.00">
    </div>
    
    <div>
      <label for="from">From</label>
      <select id="from">
        <option value="THB">THB</option>
        <option value="USD">USD</option>
        <option value="EUR">EUR</option>
        <option value="JPY">JPY</option>
        <option value="GBP">GBP</option>
      </select>
    </div>
    
    <div>
      <label for="to">To</label>
      <select id="to">
        <option value="USD">USD</option>
        <option value="THB">THB</option>
        <option value="EUR">EUR</option>
        <option value="JPY">JPY</option>
        <option value="GBP">GBP</option>
      </select>
    </div>
    
    <div>
      <label>&nbsp;</label>
      <button type="button" id="convertBtn">Convert</button>
    </div>
  </div>

  <p id="result"></p>
</div>



<script>
async function convertCurrency() {
  const amount = parseFloat(document.getElementById("amount").value);
  const from = document.getElementById("from").value;
  const to = document.getElementById("to").value;
  const resultEl = document.getElementById("result");

  resultEl.classList.remove("text-success", "text-danger");

  if (isNaN(amount) || amount <= 0) {
    resultEl.classList.add("text-danger");
    resultEl.textContent = "Please enter a valid amount.";
    return;
  }
  resultEl.style.color = "var(--muted)";
  resultEl.textContent = "Converting...";

  try {
    const res = await fetch(`https://v6.exchangerate-api.com/v6/d84beb71e41ac527eb17292c/latest/${from}`);
    const data = await res.json();

    if (data.result !== "success") {
      resultEl.classList.add("text-danger");
      resultEl.style.color = "";
      resultEl.textContent = "Error fetching rate.";
      return;
    }

    const rate = data.conversion_rates[to];
    const converted = amount * rate;
    const result = converted.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    // 5. ‡πÉ‡∏ä‡πâ Class .text-success (CSS ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°)
    resultEl.classList.add("text-success");
    resultEl.style.color = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏µ "Converting..."
    
    resultEl.innerHTML = `<b>${amount.toLocaleString()}</b> ${from} = <b>${result}</b> ${to}
                          <small>Rate: 1 ${from} = ${rate.toFixed(4)} ${to}</small>`;

  } catch (err) {
    // 6. ‡πÉ‡∏ä‡πâ Class .text-danger
    resultEl.classList.add("text-danger");
    resultEl.style.color = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏µ "Converting..."
    resultEl.textContent = "Error connecting to API.";
    console.error(err); // Log error ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢
  }
}

// ‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏ú‡∏π‡∏Å Event (‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡πÉ‡∏ô DOMContentLoaded ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå)
document.addEventListener('DOMContentLoaded', () => {
    const convertBtn = document.getElementById("convertBtn");
    if (convertBtn) {
        convertBtn.addEventListener("click", convertCurrency);
    }
});
</script>


<script>
  const labels = {{ labels|tojson }};
  const incomeData = {{ income_data|tojson }};
  const expenseData = {{ expense_data|tojson }};

  const ctx = document.getElementById('historyChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        { label: 'Income', data: incomeData },
        { label: 'Expense', data: expenseData }
      ]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });
</script>
{% endblock %}
